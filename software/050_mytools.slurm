#!/bin/env bash
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=4:00:00
#SBATCH --mem=32gb
#SBATCH --tmp=8gb
#SBATCH --error=%x.e%j
#SBATCH --output=%x.o%j
#SBATCH --export=NONE
#SBATCH --mail-type=FAIL
#SBATCH --partition=msismall

set -euo pipefail

# Function to reliably get script directory
slurm_script_dir() {
  local script_path
  
  if [[ -n "${SLURM_SUBMIT_DIR-}" ]] && [[ -n "${SLURM_JOB_ID-}" ]] && command -v scontrol >/dev/null 2>&1; then
    script_path="$(scontrol show job "$SLURM_JOB_ID" -o 2>/dev/null | sed -n 's/.*Command=\([^ ]*\).*/\1/p')"
    
    if [[ -n "$script_path" ]] && [[ "$script_path" != "bash" ]] && [[ -f "$script_path" ]]; then
      script_path="$script_path"
    else
      script_path="${BASH_SOURCE[0]}"
    fi
  else
    script_path="${BASH_SOURCE[0]}"
  fi
  
  script_path="$(readlink -f "$script_path")"
  dirname "$script_path"
}

# Get project root and setup paths
SCRIPT_DIR="$(slurm_script_dir)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Output directory matching this script's name
OUTPUT_DIR="${PROJECT_ROOT}/software_out/050_mytools"

echo "Installing simple tools to ${OUTPUT_DIR}"

# Rename existing output directory if it exists
if [ -d "${OUTPUT_DIR}" ]; then
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    OLD_DIR="${PROJECT_ROOT}/software_out/050_mytools_DELETE_THIS_${TIMESTAMP}"
    echo "Existing output directory found. Renaming to: 050_mytools_DELETE_THIS_${TIMESTAMP}"
    mv "${OUTPUT_DIR}" "${OLD_DIR}"
fi

# Create output directory
mkdir -p "${OUTPUT_DIR}"

# ---------------------------------------------------------------------
# Install Tool 1: cephtools
# ---------------------------------------------------------------------
echo "Installing cephtools..."
CEPHTOOLS_VERSION="3.11.0"
cd "${OUTPUT_DIR}"
wget -q "https://github.com/umn-msi-lmnp/cephtools/releases/download/${CEPHTOOLS_VERSION}/cephtools-${CEPHTOOLS_VERSION}.tar.gz"
tar -xzf "cephtools-${CEPHTOOLS_VERSION}.tar.gz"
echo "cephtools ${CEPHTOOLS_VERSION} installed"

# ---------------------------------------------------------------------
# Install Tool 2: Example (uncomment and modify as needed)
# ---------------------------------------------------------------------
# echo "Installing another_tool..."
# ANOTHER_TOOL_VERSION="1.2.3"
# cd "${OUTPUT_DIR}"
# wget -q "https://example.com/another_tool-${ANOTHER_TOOL_VERSION}.tar.gz"
# tar -xzf "another_tool-${ANOTHER_TOOL_VERSION}.tar.gz"
# echo "another_tool ${ANOTHER_TOOL_VERSION} installed"

# ---------------------------------------------------------------------
# Install Tool 3: Example git clone (uncomment and modify as needed)
# ---------------------------------------------------------------------
# echo "Installing git_tool..."
# GIT_TOOL_VERSION="v1.2.3"
# cd "${OUTPUT_DIR}"
# git clone --depth 1 --branch "${GIT_TOOL_VERSION}" "https://github.com/user/repo.git" "git_tool-${GIT_TOOL_VERSION}"
# echo "git_tool ${GIT_TOOL_VERSION} installed"

# ---------------------------------------------------------------------
# Create activation script
# ---------------------------------------------------------------------
echo "Generating activation script..."
cat > "${OUTPUT_DIR}/use_mytools.sh" << ACTIVATION_SCRIPT
#!/bin/env bash
# Auto-generated activation script for simple tools
# Generated by: software/050_mytools.slurm
# DO NOT EDIT MANUALLY - will be regenerated when tools are rebuilt

# ---------------------------------------------------------------------
# Check if script is being sourced or executed
# ---------------------------------------------------------------------
if [ "\${BASH_SOURCE[0]}" = "\${0}" ]; then
    echo "ERROR: This script must be sourced, not executed directly."
    echo ""
    echo "Usage:"
    echo "  source \${BASH_SOURCE[0]}"
    echo ""
    echo "Or:"
    echo "  . \${BASH_SOURCE[0]}"
    echo ""
    echo "Explanation:"
    echo "  This script modifies your current shell environment (PATH)."
    echo "  Executing it directly creates a subshell that exits immediately."
    echo "  Sourcing it runs the commands in your current shell."
    exit 1
fi

# Absolute paths (generated at build time)
PROJECT_ROOT="${PROJECT_ROOT}"
MYTOOLS_DIR="\${PROJECT_ROOT}/software_out/050_mytools"

# ---------------------------------------------------------------------
# Add tool paths to PATH
# IMPORTANT: Update this section when you add/remove tools
# ---------------------------------------------------------------------

# Tool 1: cephtools
export PATH="\${MYTOOLS_DIR}/cephtools-${CEPHTOOLS_VERSION}/bin:\${PATH}"

# Tool 2: another_tool (uncomment when you add this tool)
# export PATH="\${MYTOOLS_DIR}/another_tool-1.2.3/bin:\${PATH}"

# Tool 3: git_tool (uncomment when you add this tool)
# export PATH="\${MYTOOLS_DIR}/git_tool-v1.2.3/bin:\${PATH}"

# ---------------------------------------------------------------------
# Set any tool-specific environment variables here (optional)
# ---------------------------------------------------------------------
# export CEPHTOOLS_HOME="\${MYTOOLS_DIR}/cephtools-${CEPHTOOLS_VERSION}"

# ---------------------------------------------------------------------
# Print activation message
# ---------------------------------------------------------------------
printf "\n"
printf "%s\n" "----------------------------------"
printf "Simple tools activated!\n\n"
printf "Project root: %s\n" "\${PROJECT_ROOT}"
printf "Tools directory: %s\n\n" "\${MYTOOLS_DIR}"
printf "Tools added to PATH:\n"
printf "  - cephtools ${CEPHTOOLS_VERSION}\n"
# printf "  - another_tool 1.2.3\n"
# printf "  - git_tool v1.2.3\n"
printf "\nTo stop using these tools, exit the shell:\n"
printf "  exit\n"
printf "%s\n\n" "----------------------------------"
ACTIVATION_SCRIPT

chmod +x "${OUTPUT_DIR}/use_mytools.sh"
echo "Activation script created at: ${OUTPUT_DIR}/use_mytools.sh"
echo ""
echo "Done! All mytools outputs are in ${OUTPUT_DIR}/"
echo ""
echo "To use these tools:"
echo "  source ${OUTPUT_DIR}/use_mytools.sh"
